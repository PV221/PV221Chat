@model List<PV221Chat.DTO.MessageDTO>


<div>
    <div class="chat-messages" id="chatMessages">
        @foreach (var message in Model)
        {
            <div class="message @(message.SenderId.ToString() == User.Claims.FirstOrDefault(c => c.Type == "UserId")?.Value ? "sent" : "received")">
                <div class="message-content">@message.MessageText</div>
                <div class="message-time">@message.SentAt?.ToString("HH:mm")</div>
            </div>
        }
    </div>

    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Введите сообщение..." />
        <button id="sendMessageButton">Отправить</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.18/signalr.min.js"></script>

<script>
    const currentUserId = "@User.Claims.FirstOrDefault(c => c.Type == "UserId")?.Value";
    const currentUserName = "@User.Identity.Name";

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();

    document.getElementById("sendMessageButton").disabled = true;

    connection.start().then(function () {
        document.getElementById("sendMessageButton").disabled = false;
    }).catch(function (err) {
        return console.error(err.toString());
    });

    connection.on("ReceiveMessage", function (user, message) {
        const msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const encodedMsg = user + " говорит: " + msg;
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML += `<div class="message received"><div class="message-content">${encodedMsg}</div></div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    document.getElementById("sendMessageButton").addEventListener("click", function (event) {
        const message = document.getElementById("messageInput").value;
        if (message.trim() !== '') {
            connection.invoke("SendMessage", currentUserName, message).catch(function (err) {
                return console.error(err.toString());
            });
            document.getElementById('messageInput').value = '';
        }
        event.preventDefault();
    });
</script>
